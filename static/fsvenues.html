<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Foursquare Venues Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map-canvas { height: 500px; width: 500px }
  </style>
</head>
<body>
  <form action="javascript:getGeoAndSubmit()">
    <input id="fsvQuery" type="text">
    <input type="submit" value="Find Venues">
  </form>

  <ul id="results">

  </ul>

  <div id="map-canvas" style="width: 100%; height:100%">

  </div>

  <script src="jquery-1.9.0.js"></script>
  <script src="addTappableJQPlugin.js"></script>
  <script type="text/javascript"
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtjE9cT2HWJpuf745-cYh7rP_E1CPRE-c&sensor=true">
  </script>
  <script src="gmapVenueDisplay.js"></script>

  <script type="text/javascript">

  var g = {lat: 0, lon: 0};


  function getGeoAndSubmit(){
    navigator.geolocation.getCurrentPosition(submitFSVSearch);
  }

  function submitFSVSearch(position){
    var fsvQuery = $("#fsvQuery");
    var query = fsvQuery.val();
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;
    g['lat'] = lat;
    g['lon'] = lon;

    fsvQuery.val("");

    $.ajax({
      type:"get",
      data: {query: query, 
        latitude: lat, 
        longitude: lon},
        url:"/foursquare-venues",
        success: function(data){
          displayResults(data);
          initGmap(lat, lon);}
        });
  }

  function displayResults(data){
    data.results = JSON.parse(data.results);
    var venues = data.results.response.venues;
    var MAXENTRIES = 5;
    var i;

    var nEntries = Math.min(venues.length, MAXENTRIES);
    var sortedVenues = venues.sort(function(a,b){
      return a.location.distance - b.location.distance;
    });

    g.sortedVenues = sortedVenues;

    getAndDisplayWalkingDistance(sortedVenues.slice(0,nEntries+1))
  }

  function getAndDisplayWalkingDistance(venues){
    var queries = "";
    var origins;
    var i = 0;

    g.displayedVenues = venues;
    
    for(i = 0; i < venues.length; i++){
      queries = queries + venues[i].location.lat + ","
      + venues[i].location.lng + "|";
    }

    queries = queries.substring(0, queries.length - 1);

    origins = g.lat + "," + g.lon;

    $.ajax({
      type:"get",
      data:{queries:queries, 
        origins:origins},
        url:"/google-walking-distance",
        success: function(data){
          var results = JSON.parse(data.results);
          var resultsDiv = $("#results");
          resultsDiv.html("");
          for(i = 0; i < venues.length; i++){
            var newDiv = $("<li>");

            newDiv.attr("id", i);
            newDiv.onButtonTap(markerHandler);

            newDiv.html(venues[i].name + ", Steps: " 
              + results.rows[0].elements[i].distance.text);
            resultsDiv.append(newDiv);
          }
        }
      });

  }
  </script>
</body>

</html>